# Министерство образования и науки Российской Федерации
## Уральский федеральный университет имени первого Президента России Б. Н. Ельцина

### Курс “DevOps: Виртуализация и облачные вычисления для бизнеса”

## Отчет по практической работе №3
### «Мониторинг, логирование и оповещение событий»

#### Выполнил:
Силинкин Иван, РИ-310932

г. Екатеринбург

---

## Введение
**Цель работы:**
Установить и настроить системы мониторинга Prometheus, AlertManager и node_exporter на виртуальной машине.

**Задачи:**
1. Синхронизировать время на машине и открыть необходимые порты для систем мониторинга.
2. Установить и настроить Prometheus.
3. Установить и настроить AlertManager.
4. Установить и настроить node_exporter.
5. Связать AlertManager и node_exporter с Prometheus.
6. Настроить мониторинг служб Linux.

---

## Оглавление
1. Введение
2. Ход работы:
    - Синхронизация времени и открытие портов для систем мониторинга
    - Установка и настройка Prometheus
    - Установка и настройка AlertManager
    - Установка и настройка node_exporter
    - Связка AlertManager и node_exporter с Prometheus
    - Мониторинг служб Linux
3. Вывод

---

## Ход работы

### Синхронизация времени и открытие портов для систем мониторинга

Для синхронизации времени на виртуальной машине используем пакет `chrony`, который уже был установлен в систему.

![Запуск chrony](img.png)

Затем открываем необходимые TCP и UDP порты, которые будут использоваться системами мониторинга.

![Открытие портов](img_1.png)

Так как на машине установлена Linux Ubuntu, SELinux не активен.

![Проверка SELinux](img_2.png)

### Установка и настройка Prometheus

Первым шагом необходимо скачать пакет Prometheus для Linux.

![Скачивание пакета Prometheus](img_3.png)

После скачивания архива `prometheus`, распаковываем его и распределяем содержимое по различным каталогам. Создаем необходимые директории.

![Создание директорий для Prometheus](img_4.png)

Распределяем разархивированные файлы по соответствующим каталогам.

![Распределение файлов по каталогам](img_5.png)

Далее создаем пользователя, от имени которого будет запускаться система мониторинга Prometheus.

![Создание пользователя для Prometheus](img_6.png)

Закрепляем ранее созданные каталоги за новым пользователем и запускаем Prometheus.

![Закрепление каталогов и запуск Prometheus](img_7.png)

Проверяем, что Prometheus запущен, перейдя по адресу хоста и порту 9090.

![Запущенная система мониторинга Prometheus](img_8.png)

Для удобства настраиваем автозапуск системы, создав конфигурационный файл `prometheus.service`.

![Содержимое файла prometheus.service](img_9.png)

Перечитываем конфигурацию, разрешаем автозапуск и проверяем корректность работы службы.

![Перечитывание конфигурации и активация автозапуска](img_10.png)
![Запуск службы и проверка корректности работы](img_11.png)

### Установка и настройка AlertManager

Скачиваем пакет AlertManager для Linux.

![Скачивание пакета AlertManager](img_12.png)

Создаем необходимые каталоги и распаковываем скачанный архив.

![Создание каталогов и распаковка архива AlertManager](img_13.png)

Распределяем файлы по соответствующим каталогам.

![Распределение файлов по каталогам](img_14.png)

Создаем пользователя, от имени которого будет запускаться AlertManager.

![Создание пользователя для AlertManager](img_15.png)

Настраиваем автозапуск, создав файл `alertmanager.service`.

![Настройка автозапуска для AlertManager](img_16.png)
![Перечитывание конфигурации и перезапуск службы](img_17.png)

Проверяем, что AlertManager запущен, перейдя по адресу хоста и порту 9093.

![Запущенная система мониторинга AlertManager](img_18.png)

### Установка и настройка node_exporter

Скачиваем пакет node_exporter для Linux.

![Скачивание пакета node_exporter](img_19.png)

Распаковываем скачанный архив и копируем его содержимое по пути `/usr/local/bin`.

![Распаковка архива и копирование содержимого](img_20.png)

Создаем пользователя, от имени которого будет запускаться node_exporter.

![Создание пользователя для node_exporter](img_21.png)

Настраиваем автозапуск, создав файл `node_exporter.service`.

![Настройка автозапуска для node_exporter](img_22.png)
![Перечитывание конфигурации и перезапуск службы](img_23.png)

Проверяем, что node_exporter запущен, перейдя по адресу хоста и порту 9100.

![Запущенная система мониторинга node_exporter](img_24.png)

### Связка AlertManager и node_exporter с Prometheus

Для интеграции node_exporter и AlertManager с Prometheus, добавляем адрес машины, на которой запущен node_exporter, в файл `prometheus.yml`.

![Изменение файла prometheus.yml](img_25.png)

Проверяем, что во вкладке Targets системы мониторинга Prometheus отображаются метрики node_exporter.

![Метрики node_exporter внутри Prometheus](img_26.png)

Теперь интегрируем AlertManager в Prometheus. Создаем правило `alert.rules.yml` и подключаем его в `prometheus.yml`.

![Создание правила alert.rules.yml](img_27.png)
![Подключение правила тревоги в prometheus.yml](img_28.png)

Отключаем службу node_exporter и проверяем наличие уведомления об этом во вкладке Alerts.

![Отключение службы node_exporter](img_29.png)
![Уведомление об отключении во вкладке Alerts Prometheus](img_30.png)

Настраиваем отправку уведомлений на почту в случае недоступности службы node_exporter.

![Настройка отправки уведомлений на почту](img_31.png)
![Настройка привязки AlertManager к Prometheus](img_32.png)

### Мониторинг служб Linux

Для мониторинга сервисов с помощью Prometheus настраиваем сбор метрик и отображение тревог. Изменяем файл `node_exporter.service` для мониторинга всех служб, кроме `auditd`, `dbus` и `kdump`.

![Изменённый файл node_exporter.service](img_33.png)

Настраиваем мониторинг для Nginx, создав новое правило в файле `services.rules.yml`.

![Создание нового правила в services.rules.yml](img_34.png)
![Подключение нового правила в конфиг Prometheus](img_35.png)

Перезагружаем Prometheus, останавливаем nginx и проверяем, что пришло уведомление о его отключении.

![Остановка nginx](img_36.png)
![Уведомление об отключённом nginx](img_37.png)

---

## Вывод

В ходе данной практической работы была проведена синхронизация времени на машине с помощью пакета chrony для корректной работы пакетов мониторинга системы: Prometheus, AlertManager и node_exporter. Для каждого из пакетов были открыты требуемые UDP и TCP порты с помощью команды `ufw allow`. Все пакеты были загружены в виде архивов с соответствующих репозиториев GitHub. После распаковки и размещения файлов по каталогам, для каждой системы мониторинга был создан пользователь, от имени которого запускалась служба. После проверки работоспособности мониторинговых систем, для них был настроен автозапуск посредством создания файлов `prometheus.service`, `alertmanager.service` и `node_exporter.service`. Было настроено отображение метрик node_exporter внутри Prometheus путем добавления нового job_name в файл `prometheus.yml` и указания адреса машины, на которой запущен node_exporter. При потере соединения с node_exporter во вкладке Alerts отображается уведомление о недоступности службы. Также была настроена отправка уведомлений по протоколу SMTP на почту в случае события InstanceDown. Помимо интеграции с другими системами мониторинга, было настроено отслеживание состояния службы nginx путем создания файла `services.rules.yml`, который был подключен в конфиг `prometheus.yml`.
