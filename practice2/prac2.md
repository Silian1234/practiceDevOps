# Министерство образования и науки Российской Федерации
## Уральский федеральный университет имени первого Президента России Б. Н. Ельцина

### Курс “DevOps: Виртуализация и облачные вычисления для бизнеса”

## Отчет по практической работе №2
### «Построение кластера»

#### Выполнил:
Силинкин Иван, РИ-310932

г. Екатеринбург

---

## Введение
**Цель работы:**
Соединить три виртуальные машины в единый кластер с использованием Pacemaker.

**Задачи:**
1. Добавить IP-адреса других узлов в файл `/etc/hosts` на всех узлах.
2. Синхронизировать время между узлами.
3. Настроить обмен через SSH-ключи.
4. Установить пакет Pacemaker и создать кластер.
5. Произвести первоначальную настройку кластера.
6. Настроить СУБД PostgreSQL.
7. Создать ресурсы кластера.
8. Ознакомиться с ресурсами фенсинга.

---

## Оглавление
1. Введение
2. Ход работы:
    - Создание узлов в гипервизоре
    - Синхронизация времени узлов
    - Настройка обмена через SSH-ключи
    - Установка пакета Pacemaker
    - Первоначальная настройка кластера
    - Настройка СУБД PostgreSQL
    - Создание ресурса кластера
    - Ознакомление с ресурсами фенсинга
3. Вывод

---

## Ход работы

### Создание узлов в гипервизоре

Подключаемся к одному из узлов по SSH и редактируем файл `/etc/hosts` для добавления IP-адресов других узлов.

![Подключение по SSH к узлу](image1.png)
![Редактирование файла /etc/hosts](image2.png)

Повторяем эту операцию для всех остальных узлов.

### Синхронизация времени узлов

Проверяем синхронизацию времени между узлами с помощью команды `date`.

![Проверка синхронизации времени узлов](image3.png)

### Настройка обмена через SSH-ключи

Генерируем SSH-ключ командой `ssh-keygen`.

![Генерация SSH-ключа](image4.png)

Копируем сгенерированный ключ на другие узлы командой `ssh-copy-id`.

![Копирование SSH-ключа на другие узлы](image5.png)

Теперь можно подключаться по SSH без ввода пароля.

![Подключение по SSH без ввода пароля](image6.png)

Настраиваем SSH для ОС Windows, чтобы подключаться напрямую из Powershell без ввода пароля.

![Генерация ключа для ОС Windows](image7.png)

Пишем BASH-скрипт для копирования ключа, так как в Windows отсутствует команда `ssh-copy-id`.

![BASH-скрипт для копирования SSH-ключа](image8.png)

Используем этот скрипт для копирования ключа на узлы Ubuntu.

![Копирование SSH-ключа на узлы Ubuntu](image9.png)

Проверяем возможность подключения по SSH без пароля через Windows Powershell.

![Подключение по SSH без пароля из Windows к Ubuntu](image10.png)

### Установка пакета Pacemaker

Устанавливаем пакеты `pacemaker`, `fence-agents` и `postgresql` на каждый из узлов.

![Установка необходимых пакетов](image11.png)

Заменяем несовместимую версию пакета `resource-agents` на совместимую версию 4.7.0.

![Удаление несовместимой версии пакета resource-agents](image12.png)
![Установка совместимой версии пакета resource-agents](image13.png)

### Первоначальная настройка кластера

Меняем пароль пользователя `hacluster`.

![Смена пароля пользователя hacluster](image14.png)

Проводим аутентификацию всех узлов в кластере, указав пользователя `hacluster` и его новый пароль.

![Аутентификация узлов в кластере](image15.png)

Настраиваем автоматический запуск кластера при старте системы.

![Настройка автозапуска кластера](image16.png)

Проверяем статус кластера и синхронизацию его узлов.

![Проверка статуса кластера](image17.png)
![Проверка синхронизации узлов кластера](image18.png)

### Настройка СУБД PostgreSQL

Отключаем запуск `postgresql.service` при старте системы, так как теперь за это будет отвечать Pacemaker.

![Отключение postgresql.service](image19.png)

Инициализируем и запускаем новую БД на мастер-узле.

![Инициализация и запуск новой БД](image20.png)

Сменяем пароль пользователя `postgres`.

![Смена пароля пользователя postgres](image21.png)

Создаем пользователя для репликации.

![Создание пользователя для репликации](image22.png)

Редактируем `pg_hba.conf` для установки необходимых разрешений.

![Редактированный pg_hba.conf](image23.png)

Изменяем `postgresql.conf`.

![Редактированный postgresql.conf](image24.png)

Перезапускаем `postgresql` на мастер-узле.

![Перезапуск процесса postgresql](image25.png)

Очищаем директорию `postgresql/12/main` на остальных узлах и копируем БД с мастер-узла.

![Очистка main-директории и копирование БД](image26.png)

### Создание ресурса кластера

Создаем ресурс типа `IPaddr` для подключения к БД PostgreSQL.

![Создание ресурса типа IPaddr](image27.png)

Создаем ресурс типа `pgsql` для управления конфигурацией PostgreSQL.

![Создание ресурса типа pgsql](image28.png)

Связываем два созданных ресурса, чтобы они запускались вместе на одном узле, и устанавливаем им очередность запуска.

![Настройка очередности запуска ресурсов](image29.png)

### Ознакомление с ресурсами фенсинга

Выводим список всех доступных `fence-agents`.

![Список всех доступных fence-agents](image30.png)

Используем агент `fence_virsh`.

![Использование агента fence-virsh](image31.png)

---

## Вывод

В ходе данной практической работы была произведена настройка привязки машины за ее IP-адресом путем редактирования файла `/etc/hosts`. Также была проверена синхронизация времени между тремя узлами ОС Linux Ubuntu Server 20.04. На каждой машине был настроен обмен через SSH путем генерации уникального ключа командой `ssh-keygen` и дальнейшего копирования его публичной части на другие машины командой `ssh-copy-id`. Для ОС Windows был написан Bash-скрипт, имитирующий тот же функционал в связи с отсутствием команды в системе. После этого был установлен пакет Pacemaker для создания кластера из трех узлов. Так как зависимость `resource-agents`, включенная в данный пакет, оказалась несовместимой с PostgreSQL 12, была произведена установка другой версии зависимости. После установки пакета все
